# AGENTS.md â€” Guidance for Humans & AI Agents

*(Scope: entire repository; nested **`AGENTS.md`** files take precedence if added later.)*

---

## 1â€Šâ€ŠProject at a Glance

| Area              | Path(s)                                              | Notes                                             |
| ----------------- | ---------------------------------------------------- | ------------------------------------------------- |
| Flask entryâ€‘point | `app.py`                                             | Web UI, REST, background scheduler bootstrap      |
| Models & ORM      | `models.py`                                          | SQLAlchemy, Alembic migrations viaÂ `flask db *`   |
| Discovery         | `inventory.py`, `redfish_client.py`                  | vCenter & Redfish helpers                         |
| Firmware Engine   | `update.py`                                          | Idempotent, retryâ€‘aware upload & apply logic      |
| Scheduler         | `scheduler.py`                                       | APScheduler cron/interval jobs                    |
| CLI / Setup       | `init_db.py`, `utils.py`, `validators.py`            | `.env` bootstrap & sanity checks                  |
| Frontâ€‘end         | `templates/*`, `static/*`                            | Jinja2 + vanillaÂ JS/CSS                           |
| Service files     | `apache_idrac_updater.conf`, `idrac_updater.service` | Apache vhost (Kerberos SSO) & systemd alternative |

---

## 2â€Šâ€ŠCoding Conventions

| Tool           | Version Pin              | Invocation                   |
| -------------- | ------------------------ | ---------------------------- |
| **Python**     | 3.11 (RHELÂ 9 SCL)        | â€”                            |
| **Black**      | 24.x,Â `lineâ€‘lengthâ€¯=â€¯88` | `black .`                    |
| **isort**      | 5.x, profileÂ =`black`    | `isort .`                    |
| **Flake8**     | 7.x                      | `flake8`                     |
| **Mypy**       | 1.10 (soft fail)         | `mypy .`                     |
| **Preâ€‘commit** | 3.x                      | `preâ€‘commit run --all-files` |

- Docstrings â†’ Googleâ€‘style
- Use **type hints** everywhere; treat `mypy` warnings as TODOs.
- Avoid circular importsâ€”split utility code into `utils.py` or a new module if needed.
- **No print debugging**; use `logging.getLogger("firmware_maestro")`.

### Imports

```python
# âœ… good
from inventory import discover_vcenter
from models import Host, Schedule

# âŒ bad
import inventory
from models import *
```

---

## 3â€Šâ€ŠBranch & PR Guidelines

1. **Branch naming**:\
   `feat/<shortâ€‘slug>`, `fix/<issueâ€‘ref>`, `chore/<task>`, `docs/<area>`.
2. **PR title** â†’ imperative, â‰¤â€¯72Â chars.\
   Examples: `feat: add OAuth2 fallback for local users`
3. **PR description template** (fill in all sections):
   ```
   ## What & Why
   <concise context and motivation>

   ## Changes
   - Bullet
   - Point

   ## How to test
   1. ...
   2. ...

   ## Screenshots / Logs
   <optional>

   ## Risks & Mitigations
   <optional>

   Closes #<issue>, RelatedÂ #<issue>
   ```
4. **Status checks** must pass: `lint`, `unit`, `integration` (see `.github/workflows/ci.yml`).
5. **Commit messages** must be DCOâ€‘signed: `git commit -s -m "..."`.

---

## 4â€Šâ€ŠEnvironment Variables

| Variable            | Default                 | Description                                         |
| ------------------- | ----------------------- | --------------------------------------------------- |
| `FLASK_ENV`         | `production`            | `production`, `development`, or `testing`           |
| `FM_SECRET_KEY`     | *required*              | Flask session & CSRF secret                         |
| `DATABASE_URL`      | `sqlite:///data/app.db` | SQLAlchemy connection string                        |
| `FIRMWARE_REPO_DIR` | `/firmware`             | Mounted volume with `.d7` or `.exe` images          |
| `VCENTER_HOST`      | â€”                       | Optional vCenter for discovery                      |
| `LOG_LEVEL`         | `INFO`                  | Python logging level                                |
| `ENABLE_METRICS`    | `false`                 | If `true`, exposes Prometheus metrics on `/metrics` |
| `TRACING_ENDPOINT`  | â€”                       | OpenTelemetry collector URL                         |

All env vars are loaded via [`python-dotenv`](https://pypi.org/project/python-dotenv/). Secrets **must not** be committed to Git.

---

## 5â€Šâ€ŠTesting & Validation

| Layer       | Framework            | Command                        |
| ----------- | -------------------- | ------------------------------ |
| Unit        | **pytest** 8.x       | `pytest -q`                    |
| Coverage    | pytestâ€‘cov â‰¥â€¯90â€¯%    | `pytest --cov=idrac_updater`   |
| Integration | marker `integration` | Requires vCenter/iDRAC testbed |
| Static      | preâ€‘commit linters   | `pre-commit run --all-files`   |

> **Programmatic check**
>
> ```bash
> ./scripts/checks.sh
> ```
>
> Script returns nonâ€‘zero on any failure (lint, typeâ€‘check, tests). **Run before pushing**.

---

## 6â€Šâ€ŠRunning Locally

```bash
# 1. Create env\python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# 2. Configure
cp .env.example .env          # edit values or run python init_db.py --wizard
flask db upgrade              # creates SQLite DB if absent

# 3. Launch (development)
flask --app app run --reload
```

### Container Build & Release

Build is automated via **Podman** + **GitHub Actions**.

*Local build/test*

```bash
podman build -t idrac_updater:dev .
podman run --rm -p 8080:8080 --env-file .env idrac_updater:dev
```

*Release pipeline*

1. Tag commit `vX.Y.Z` (SemVer).
2. GitHub Action publishes to `quay.io/idrac_updater`.
3. SBOM + image provenance signed via **cosign**.

---

## 7â€Šâ€ŠDatabase & Migrations

- ORM: **SQLAlchemy**; use `db.Model`.
- Migrations: **Flaskâ€‘Migrate/Alembic**.

Create a revision:

```bash
flask db migrate -m "Describe change"
flask db upgrade
```

---

## 8â€Šâ€ŠLogging & Observability

- Logs: configured via `logging_config.py`; daily rotation, keep 14 files.
- Metrics: optional Prometheus exporter (enable with `ENABLE_METRICS=true`).
- Tracing: OpenTelemetry ([https://opentelemetry.io/](https://opentelemetry.io/)) if `TRACING_ENDPOINT` set.
- Sensitive data **must be redacted** before logging.

---

## 9â€Šâ€ŠSecurity Hardening Checklist

-

---

## 10â€Šâ€ŠContributing Workflow

1. **Fork & clone** or create a feature branch if you are a maintainer.
2. **Run checks** locally (`./scripts/checks.sh`).
3. **Open PR** against `main`.
4. A maintainer will **review** within 2 business days.
5. **Squashâ€‘merge** preferred; maintainers may reâ€‘title commits.
6. After merge, **GitHub Actions** deploys `edge` container.

---

## 11â€Šâ€ŠSupport & Maintenance

| Channel                        | Usage                         | SLA           |
| ------------------------------ | ----------------------------- | ------------- |
| GitHub Issues                  | Bug reports, feature requests | Triage < 24â€¯h |
| IRCÂ `#idrac-updater`           | Quick questions               | Bestâ€‘effort   |
| PagerDuty â€œiDracâ€‘Updaterâ€‘Prodâ€ | Production alerts only        | 15â€¯min        |

Weekly on Monday 09:00Â UTC we run **dependency updates** via Renovate.

---

## 12â€Šâ€ŠFAQ

---

## 13â€Šâ€ŠLicense

```
SPDXâ€‘Licenseâ€‘Identifier: Apacheâ€‘2.0
```

Unless stated otherwise, all new files should include the SPDX line above at the top or in the module docstring.

---

## 14â€Šâ€ŠContact & Ownership

- **Code owners**: `@i0mja`, `@redhatâ€‘firmwareâ€‘maestro`
- Preferred chat: IRCÂ Libera `#idrac-updater` or Slack `@FWâ€‘Maestro`.
- Emergencies: PagerDuty schedule â€œiDracâ€‘Updaterâ€‘Prodâ€.

---

Happy shipping! ğŸš€

